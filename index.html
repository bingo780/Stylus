<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JIS Dekurz v12.0 - AutoSave</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root { --primary: #007AFF; --bg: #333; }
        * { box-sizing: border-box; }
        body, html { margin: 0; padding: 0; background: var(--bg); font-family: sans-serif; height: 100%; overflow: hidden; }

        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 9999;
            display: none; align-items: center; justify-content: center;
            color: white; font-size: 20px; font-weight: bold; flex-direction: column;
        }
        
        /* NOTIFIK√ÅCIA O ULO≈ΩEN√ç */
        #saveStatus {
            position: fixed; top: 10px; right: 10px; 
            background: rgba(46, 204, 113, 0.9); color: white; 
            padding: 5px 10px; border-radius: 5px; font-size: 12px; 
            z-index: 3000; opacity: 0; transition: opacity 0.5s; pointer-events: none;
        }

        ::-webkit-scrollbar { width: 20px; }
        ::-webkit-scrollbar-track { background: #444; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; border: 3px solid #222; }

        /* OVL√ÅDAC√ç PANEL */
        .settings-panel {
            position: fixed; top: 5px; left: 50%; transform: translateX(-50%);
            background: white; padding: 5px 10px; border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5); z-index: 2000;
            display: flex; gap: 8px; align-items: center; flex-wrap: nowrap;
            max-width: 98%; overflow-x: auto;
        }
        .group { display: flex; flex-direction: column; align-items: center; border-right: 1px solid #ddd; padding-right: 5px; }
        .group:last-child { border: none; }
        .lbl { font-size: 8px; font-weight: bold; text-transform: uppercase; margin-bottom: 2px; color: #555; }
        .row { display: flex; align-items: center; gap: 2px; }

        .btn-mini { width: 32px; height: 32px; background: #eee; border: 1px solid #ccc; border-radius: 5px; font-weight: bold; font-size: 16px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .btn-mini:active { background: #007AFF; color: white; }
        .val-disp { width: 35px; text-align: center; font-size: 12px; font-weight: bold; }
        
        .color-dot { width: 28px; height: 28px; border-radius: 50%; border: 2px solid #ddd; cursor: pointer; margin: 0 2px; }
        .color-dot.active { border-color: #000; transform: scale(1.2); }

        /* MENU */
        .fab-container { position: fixed; z-index: 1000; display: flex; flex-direction: column; gap: 10px; }
        .top-left { top: 75px; left: 15px; }
        .top-right { top: 75px; right: 15px; align-items: flex-end; }
        
        .main-fab { width: 50px; height: 50px; background: rgba(255,255,255,0.95); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; border: 1px solid #ccc; box-shadow: 0 2px 5px black; }
        .menu-items { display: none; flex-direction: column; align-items: center; gap: 5px; margin-top: 5px; }
        .menu-items.active { display: flex; }
        .sub-fab { width: 45px; height: 45px; background: white; border-radius: 10px; display: flex; align-items: center; justify-content: center; border: 1px solid #ccc; font-size: 20px; }
        .active-tool { background: var(--primary); color: white; border: 2px solid white; }

        /* PL√ÅTNO */
        .viewport {
            width: 100%; height: 100%; overflow-y: scroll; overflow-x: auto;
            display: flex; justify-content: center; align-items: flex-start;
            padding-top: 90px; padding-bottom: 50px;
            background: #333; touch-action: pan-x pan-y;
        }

        #paper-wrapper {
            width: 210mm; height: 297mm;
            background: white; position: relative;
            box-shadow: 0 0 30px black; transform-origin: top center;
        }

        #bgImg { width: 100%; height: 100%; position: absolute; top: 0; left: 0; pointer-events: none; }
        #mainCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; touch-action: none; }

        /* TEXTOV√â POLIA */
        .text-box-wrapper { position: absolute; z-index: 50; }
        .control-bar { display: flex; background: var(--primary); height: 35px; align-items: center; border-radius: 4px 4px 0 0; opacity: 0.9; touch-action: none; }
        .drag-handle { flex-grow: 1; text-align: center; color: white; font-weight: bold; }
        .action-btn { background: rgba(255,255,255,0.3); border: none; color: white; width: 30px; font-weight: bold; }
        .text-content { background: rgba(255,255,255,0.4); padding: 5px; border: 2px dashed #000; font-family: Arial, sans-serif; font-weight: bold; font-size: 24px; min-width: 40px; outline: none; color: black; }

        @media print {
            body, html { margin: 0; padding: 0; background: white; width: 100%; height: 100%; overflow: hidden !important; }
            .fab-container, .settings-panel, .viewport, #loader, #saveStatus { display: none !important; }
            img.print-result { display: block !important; width: 100%; height: 100%; object-fit: contain; }
        }
    </style>
</head>
<body>

    <div id="loader">
        <div>‚è≥ Pracujem...</div>
    </div>
    
    <div id="saveStatus">üíæ Ulo≈æen√©</div>

    <div class="settings-panel">
        <div class="group">
            <span class="lbl">Farba</span>
            <div class="row">
                <div class="color-dot" style="background:black" onclick="setColor('black', this)"></div>
                <div class="color-dot" style="background:blue" onclick="setColor('blue', this)"></div>
                <div class="color-dot" style="background:red" onclick="setColor('red', this)"></div>
            </div>
        </div>
        <div class="group">
            <span class="lbl">Hr√∫bka</span>
            <div class="row">
                <div class="btn-mini" onclick="changeSize(-0.5)">-</div>
                <div id="sizeDisplay" class="val-disp">2.5</div>
                <div class="btn-mini" onclick="changeSize(0.5)">+</div>
            </div>
        </div>
        <div class="group" style="background:#fffbe6">
            <span class="lbl" style="color:#f39c12">S√Ωtos≈•</span>
            <div class="row">
                <div class="btn-mini" onclick="changeOpacity(-1)">-</div>
                <div id="opacityDisplay" class="val-disp" style="color:#f39c12">20%</div>
                <div class="btn-mini" onclick="changeOpacity(1)">+</div>
            </div>
        </div>
        <div class="group" style="background:#eef6ff">
            <span class="lbl" style="color:#007AFF">Vƒæavo/Vpravo</span>
            <div class="row">
                <div class="btn-mini" onclick="calX(-1)">‚óÄ</div>
                <div id="calXDisp" class="val-disp" style="color:#007AFF">0</div>
                <div class="btn-mini" onclick="calX(1)">‚ñ∂</div>
            </div>
        </div>
        <div class="group" style="background:#eef6ff">
            <span class="lbl" style="color:#007AFF">Hore/Dole</span>
            <div class="row">
                <div class="btn-mini" onclick="calY(-1)">‚ñ≤</div>
                <div id="calYDisp" class="val-disp" style="color:#007AFF">10</div>
                <div class="btn-mini" onclick="calY(1)">‚ñº</div>
            </div>
        </div>
    </div>

    <div class="fab-container top-left">
        <div class="main-fab" onclick="toggleMenu('sysMenu')">üìÇ</div>
        <div id="sysMenu" class="menu-items">
            <div class="sub-fab" onclick="changeZoom(0.1)">‚ûïüîç</div>
            <div class="sub-fab" onclick="changeZoom(-0.1)">‚ûñüîç</div>
            <div style="height:5px"></div>
            
            <div class="sub-fab" onclick="document.getElementById('fileIn').click()" title="S√∫bor">üìÑ</div>
            <input type="file" id="fileIn" hidden onchange="loadBg(this)">
            <div class="sub-fab" onclick="loadFromURL()" title="Online" style="background:#e1f5fe">‚òÅÔ∏è</div>
            
            <div class="sub-fab" onclick="saveJSON()">üíæ</div>
            <div class="sub-fab" onclick="document.getElementById('jsonIn').click()">üì•</div>
            <input type="file" id="jsonIn" hidden onchange="loadJSON(this)">
            <div class="sub-fab" onclick="undo()">‚Ü©Ô∏è</div>
            <div class="sub-fab" onclick="clearAll(true)" style="background:#e74c3c; color:white; font-size:12px; font-weight:bold" title="Nov√Ω h√°rok">NOV√ù</div>
        </div>
    </div>

    <div class="fab-container top-right">
        <div class="main-fab" onclick="toggleMenu('toolMenu')" id="toolIcon">üñäÔ∏è</div>
        <div id="toolMenu" class="menu-items">
            <div class="sub-fab active-tool" id="btnPen" onclick="setTool('pen')">üñäÔ∏è</div>
            <div class="sub-fab" id="btnHigh" onclick="setTool('highlighter')">üñçÔ∏è</div>
            <div class="sub-fab" id="btnEraser" onclick="setTool('eraser')">üßΩ</div>
            <div class="sub-fab" onclick="addTextObj('X', 24)">[X]</div>
            <div class="sub-fab" onclick="addTextObj('Text', 18)">T</div>
            <div style="height:10px"></div>
            <div class="sub-fab" onclick="runExport('print')" style="background:#2ecc71; color:white; font-size:24px" title="Tlaƒçi≈•">üñ®Ô∏è</div>
            <div class="sub-fab" onclick="runExport('pdf')" style="background:#e67e22; color:white; font-size:12px; font-weight:bold; display:flex; align-items:center; justify-content:center" title="PDF">PDF</div>
        </div>
    </div>

    <div class="viewport">
        <div id="paper-wrapper">
            <img id="bgImg" src="">
            <canvas id="mainCanvas"></canvas>
        </div>
    </div>

<script>
    const paper = document.getElementById('paper-wrapper');
    const canvas = document.getElementById('mainCanvas');
    const ctx = canvas.getContext('2d');
    const loader = document.getElementById('loader');
    
    // Konfigur√°cia
    const DEFAULT_URL = ""; 
    const AUTO_SAVE_KEY = "jis_dekurz_autosave";

    let tool = 'pen';
    let color = 'black';
    let size = 2.5; 
    let opacity = 20; 
    let currentZoom = 1.0;
    let printOffsetX = 0;
    let printOffsetY = 10; // Auto Offset 10
    
    let isDrawing = false;
    let history = [];
    let lastPoint = { x: 0, y: 0 };
    
    function initCanvas() {
        const dpr = window.devicePixelRatio || 1; 
        const rect = paper.getBoundingClientRect();
        canvas.width = rect.width * dpr;
        canvas.height = rect.height * dpr;
        ctx.scale(dpr, dpr);
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        
        document.getElementById('calYDisp').innerText = printOffsetY;
        
        // --- OBNOVA ZO Z√ÅLOHY PO REFRESHI ---
        setTimeout(restoreAutoSave, 500);
    }
    window.onload = initCanvas;

    // --- AUTO SAVE SYSTEM ---
    function performAutoSave() {
        // Ulo≈æ√≠ v≈°etko do pam√§te prehliadaƒça
        const saveData = {
            img: canvas.toDataURL(),
            texts: [],
            bg: document.getElementById('bgImg').src
        };
        
        document.querySelectorAll('.text-box-wrapper').forEach(el => {
            saveData.texts.push({
                l: el.style.left,
                t: el.style.top,
                txt: el.querySelector('.text-content').innerText,
                fs: el.querySelector('.text-content').style.fontSize
            });
        });

        try {
            localStorage.setItem(AUTO_SAVE_KEY, JSON.stringify(saveData));
            showSaveStatus();
        } catch (e) {
            console.log("Pam√§≈• pln√°, ned√° sa ulo≈æi≈• auto-save");
        }
    }

    function restoreAutoSave() {
        const saved = localStorage.getItem(AUTO_SAVE_KEY);
        if (saved) {
            try {
                const data = JSON.parse(saved);
                
                // 1. Pozadie
                if (data.bg && data.bg.length > 100) {
                    document.getElementById('bgImg').src = data.bg;
                }
                
                // 2. Kresba
                const img = new Image();
                img.onload = () => {
                    ctx.clearRect(0,0,paper.offsetWidth, paper.offsetHeight);
                    ctx.drawImage(img, 0, 0, paper.offsetWidth, paper.offsetHeight);
                };
                img.src = data.img;
                
                // 3. Texty
                data.texts.forEach(t => addTextObj(t.txt, parseInt(t.fs), t.l, t.t));
                
            } catch (e) { console.error("Chyba obnovy", e); }
        }
    }

    function showSaveStatus() {
        const el = document.getElementById('saveStatus');
        el.style.opacity = 1;
        setTimeout(() => el.style.opacity = 0, 1000);
    }

    // --- UI FUNKCIE ---
    function calX(d) { printOffsetX += d; document.getElementById('calXDisp').innerText = printOffsetX; }
    function calY(d) { printOffsetY += d; document.getElementById('calYDisp').innerText = printOffsetY; }
    
    function changeOpacity(d) {
        opacity += d;
        if(opacity < 1) opacity = 1;
        if(opacity > 100) opacity = 100;
        document.getElementById('opacityDisplay').innerText = opacity + "%";
        if(tool === 'highlighter') setTool('highlighter');
    }

    function toggleMenu(id) { document.getElementById(id).classList.toggle('active'); }
    function changeZoom(d) { 
        currentZoom += d; 
        if(currentZoom < 0.4) currentZoom = 0.4; 
        paper.style.transform = `scale(${currentZoom})`;
    }
    function changeSize(d) { 
        size = Math.round((size + d) * 10) / 10; 
        if(size < 0.1) size = 0.1; 
        document.getElementById('sizeDisplay').innerText = size; 
    }
    function setColor(c, el) { 
        if(tool === 'highlighter') return; 
        color = c; 
        document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('active')); 
        el.classList.add('active'); 
    }

    function setTool(t) {
        tool = t;
        document.querySelectorAll('.sub-fab').forEach(b => b.classList.remove('active-tool'));
        if (t === 'pen') {
            document.getElementById('btnPen').classList.add('active-tool');
            ctx.globalCompositeOperation = 'source-over';
        } else if (t === 'highlighter') {
            document.getElementById('btnHigh').classList.add('active-tool');
            ctx.globalCompositeOperation = 'multiply';
        } else if (t === 'eraser') {
            document.getElementById('btnEraser').classList.add('active-tool');
            ctx.globalCompositeOperation = 'destination-out';
        }
        toggleMenu('toolMenu');
    }

    function getCanvasPos(e) {
        const rect = paper.getBoundingClientRect();
        const scaleX = paper.offsetWidth / rect.width;
        const scaleY = paper.offsetHeight / rect.height;
        return { x: (e.clientX - rect.left) * scaleX, y: (e.clientY - rect.top) * scaleY };
    }

    canvas.addEventListener('pointerdown', (e) => {
        if((e.pointerType==='pen' || e.pointerType==='mouse') && e.buttons===1) {
            saveState();
            isDrawing = true;
            lastPoint = getCanvasPos(e);
            ctx.beginPath();
            ctx.moveTo(lastPoint.x, lastPoint.y);
            
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            if (tool === 'highlighter') {
                const alpha = opacity / 100;
                ctx.lineWidth = size * 5; 
                ctx.strokeStyle = `rgba(255, 235, 59, ${alpha})`; 
            } else if (tool === 'eraser') {
                ctx.lineWidth = size * 6;
            } else {
                ctx.lineWidth = size;
                ctx.strokeStyle = color;
            }
        }
    });

    canvas.addEventListener('pointermove', (e) => {
        if(!isDrawing) return;
        if(e.pointerType==='pen' && e.buttons===0) { isDrawing = false; ctx.closePath(); return; }
        
        const currentPoint = getCanvasPos(e);
        const midPoint = { x: (lastPoint.x + currentPoint.x) / 2, y: (lastPoint.y + currentPoint.y) / 2 };
        ctx.quadraticCurveTo(lastPoint.x, lastPoint.y, midPoint.x, midPoint.y);
        ctx.stroke();
        
        ctx.beginPath(); 
        ctx.moveTo(midPoint.x, midPoint.y);
        lastPoint = currentPoint;
    });

    window.addEventListener('pointerup', () => { 
        if(isDrawing) { 
            ctx.lineTo(lastPoint.x, lastPoint.y); 
            ctx.stroke(); 
            isDrawing = false; 
            ctx.closePath(); 
            performAutoSave(); // Ulo≈æi≈• po dokonƒçen√≠ ≈•ahu
        } 
    });

    function addTextObj(t, s, left, top) {
        const d = document.createElement('div');
        d.className = 'text-box-wrapper'; 
        d.style.left = left || '100px'; 
        d.style.top = top || '100px';
        d.innerHTML = `<div class="control-bar"><button class="action-btn" onclick="rs(this,-2)">A-</button><div class="drag-handle">::::</div><button class="action-btn" onclick="rs(this,2)">A+</button><button class="action-btn" style="color:#ff9999" onclick="this.closest('.text-box-wrapper').remove(); performAutoSave();">‚ùå</button></div><div class="text-content" contenteditable="true" style="font-size:${s}px" oninput="performAutoSave()">${t}</div>`;
        paper.appendChild(d); setupDrag(d);
        performAutoSave();
    }
    window.rs = (b,d) => { const e=b.closest('.text-box-wrapper').querySelector('.text-content'); let s=parseInt(e.style.fontSize)||24; e.style.fontSize=(s+d)+'px'; performAutoSave(); };
    
    function setupDrag(el) {
        const handle = el.querySelector('.control-bar'); let isDrag=false, sx, sy, sl, st;
        handle.onpointerdown = (e) => { isDrag=true; handle.setPointerCapture(e.pointerId); sx=e.clientX; sy=e.clientY; sl=el.offsetLeft; st=el.offsetTop; e.preventDefault(); e.stopPropagation(); };
        handle.onpointermove = (e) => { if(!isDrag) return; const dx=(e.clientX-sx)/currentZoom; const dy=(e.clientY-sy)/currentZoom; el.style.left=(sl+dx)+'px'; el.style.top=(st+dy)+'px'; };
        handle.onpointerup = () => { isDrag=false; performAutoSave(); };
    }

    function loadFromURL() {
        let url = prompt("Zadajte URL obr√°zka (GitHub Raw):", DEFAULT_URL);
        if(url) {
            const img = document.getElementById('bgImg');
            img.crossOrigin = "Anonymous";
            img.src = url;
            img.onerror = () => alert("Chyba naƒç√≠tania.");
            img.onload = () => performAutoSave();
        }
    }

    function createFinalImage() {
        const outputCanvas = document.createElement('canvas');
        outputCanvas.width = 2480; 
        outputCanvas.height = 3508;
        const oCtx = outputCanvas.getContext('2d');

        const bgImg = document.getElementById('bgImg');
        if (bgImg.src) {
            oCtx.drawImage(bgImg, 0, 0, outputCanvas.width, outputCanvas.height);
        }

        oCtx.drawImage(canvas, 0, 0, outputCanvas.width, outputCanvas.height);

        oCtx.textBaseline = 'top'; 
        oCtx.fillStyle = 'black';
        
        const ratioX = outputCanvas.width / paper.offsetWidth;
        const ratioY = outputCanvas.height / paper.offsetHeight;
        const unit = 11.8; 
        const calX = printOffsetX * unit;
        const calY = printOffsetY * unit;

        document.querySelectorAll('.text-box-wrapper').forEach(wrap => {
            const content = wrap.querySelector('.text-content');
            const cssX = wrap.offsetLeft;
            const cssY = wrap.offsetTop;
            
            const finalX = (cssX * ratioX) + calX;
            const finalY = (cssY * ratioY) + calY;
            
            const cssFontSize = parseFloat(window.getComputedStyle(content).fontSize);
            oCtx.font = `bold ${cssFontSize * ratioY}px Arial`;
            
            oCtx.fillText(content.innerText, finalX + (5*ratioX), finalY + (5*ratioY));
        });

        return outputCanvas.toDataURL('image/jpeg', 0.95);
    }

    async function runExport(type) {
        if(!confirm(type === 'pdf' ? "Ulo≈æi≈• PDF?" : "Spusti≈• tlaƒç?")) return;
        loader.style.display = 'flex';

        setTimeout(() => {
            const finalData = createFinalImage();

            if (type === 'print') {
                const printImg = document.createElement('img');
                printImg.src = finalData;
                printImg.className = 'print-result';
                document.body.innerHTML = '';
                document.body.appendChild(printImg);
                window.print();
                setTimeout(() => { location.reload(); }, 500);
            } else {
                try {
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    pdf.addImage(finalData, 'JPEG', 0, 0, 210, 297);
                    pdf.save('dekurz_tlac.pdf');
                } catch(e) {
                    alert("Chyba: " + e.message);
                } finally {
                    loader.style.display = 'none';
                }
            }
        }, 500);
    }

    function saveJSON(){const l=[];document.querySelectorAll('.text-box-wrapper').forEach(e=>{l.push({l:e.style.left,t:e.style.top,txt:e.querySelector('.text-content').innerText,fs:e.querySelector('.text-content').style.fontSize});});const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([JSON.stringify({img:canvas.toDataURL(),texts:l})],{type:'application/json'}));a.download='dekurz.json';a.click();}
    function loadJSON(i){const r=new FileReader();r.onload=(e)=>{const d=JSON.parse(e.target.result);const m=new Image();m.onload=()=>{ctx.clearRect(0,0,paper.offsetWidth,paper.offsetHeight);ctx.drawImage(m,0,0,paper.offsetWidth,paper.offsetHeight); performAutoSave();};m.src=d.img;document.querySelectorAll('.text-box-wrapper').forEach(x=>x.remove());d.texts.forEach(t=>addTextObj(t.txt,parseInt(t.fs), t.l, t.t));};r.readAsText(i.files[0]);}
    function loadBg(i){const r=new FileReader();r.onload=(e)=>{document.getElementById('bgImg').src=e.target.result; performAutoSave();};r.readAsDataURL(i.files[0]);}
    
    // UPRAVEN√â MAZANIE PRE NOV√ù LIST
    function clearAll(fullReset = false){
        if(confirm(fullReset ? "NOV√ù PACIENT? Vyma≈æe sa v≈°etko." : "Zmaza≈• len kresbu?")){
            ctx.clearRect(0,0,paper.offsetWidth,paper.offsetHeight);
            if(fullReset) {
                document.querySelectorAll('.text-box-wrapper').forEach(e=>e.remove());
                document.getElementById('bgImg').src = ""; // Voliteƒæn√©, ak chce≈° zmaza≈• aj podklad
                localStorage.removeItem(AUTO_SAVE_KEY); // Zmaza≈• pam√§≈•
            } else {
                performAutoSave();
            }
        }
    }
    
    function undo() { if(history.length>0){const i=new Image();i.onload=()=>{ctx.clearRect(0,0,paper.offsetWidth,paper.offsetHeight);ctx.drawImage(i,0,0,paper.offsetWidth,paper.offsetHeight); performAutoSave();};i.src=history.pop();} }
    function saveState() { if(history.length>5)history.shift(); history.push(canvas.toDataURL()); }

</script>
</body>
</html>
