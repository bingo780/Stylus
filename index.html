<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JIS Dekurz ‚Äì v1.9.28</title>
    <style>
        :root{ --bg:#eef2f6; --card:#fff; --border:#d9e0e8; --primary:#2f6fed; --save-green:#107c10; --text:#1a1a1a; }
        body{ font-family: sans-serif; margin:5px; background:var(--bg); color:var(--text); overflow: hidden; }
        
        /* OKNO, KDE VID√ç≈† CEL√ö A4 */
        .canvas-outer { 
            overflow: auto; 
            border: 2px solid #999; 
            background: #555; 
            border-radius: 8px; 
            width: 100%; 
            height: 82vh; /* Maxim√°lne vyu≈æitie v√Ω≈°ky displeja */
            position: relative;
            touch-action: pan-x pan-y;
        }
        
        .canvas-wrapper { 
            position: relative; 
            background: white; 
            margin: 0 auto; 
            transform-origin: 0 0; /* D√¥le≈æit√© pre spr√°vne pribl√≠≈æenie na bod */
            transition: transform 0.3s ease-out;
        }

        #stylusCanvas { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; 
            background: transparent; touch-action: none; 
        }
        
        #guideImg { width: 100%; display: block; pointer-events: none; }

        .toolbar { 
            display: flex; gap: 5px; padding: 8px; background: #333; color: white; border-radius: 8px; 
            margin-bottom: 5px; align-items: center;
        }
        
        button { padding: 10px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; font-size: 13px; }
        .btn-tool { background: #555; color: white; }
        .btn-tool.active { background: #fff; color: black; }
        
        #status-msg { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); color: white; padding: 5px 15px; border-radius: 20px; font-size: 12px; display: none; z-index: 100; }
    </style>
</head>
<body>

<div id="status-msg">Dr≈æ pero pre pribl√≠≈æenie...</div>

<div id="ui-container">
    <div class="toolbar">
        <input type="file" id="bgInput" accept="image/*" onchange="loadBg(this)" style="width: 120px;">
        <button onclick="undo()" style="background:#f39c12;">‚Ü© Sp√§≈•</button>
        <button id="btnBlue" class="btn-tool active" onclick="setColor('#000080', 'btnBlue')">Modr√°</button>
        <button id="btnEraser" class="btn-tool" onclick="setEraser('btnEraser')">üßΩ Guma</button>
        <button onclick="resetZoom()" id="zoomBtn" class="btn-tool">üîç Cel√° A4</button>
        <button onclick="doPrint()" style="background:var(--save-green); margin-left:auto;">üñ®Ô∏è Tlaƒçi≈•</button>
    </div>

    <div class="canvas-outer" id="scrollContainer">
        <div class="canvas-wrapper" id="canvasWrapper">
            <img src="" id="guideImg" style="display: none;">
            <canvas id="stylusCanvas"></canvas>
        </div>
    </div>
</div>

<div id="printArea">
    <div class="print-page" style="position:relative; width:210mm; height:297mm;">
        <img id="pBg" style="width:100%; height:100%;">
        <img id="pHand" style="position:absolute; top:0; left:0; width:100%; height:100%;">
    </div>
</div>

<script>
    const canvas = document.getElementById('stylusCanvas');
    const ctx = canvas.getContext('2d');
    const wrapper = document.getElementById('canvasWrapper');
    const container = document.getElementById('scrollContainer');
    const guideImg = document.getElementById('guideImg');
    const statusMsg = document.getElementById('status-msg');
    
    let drawing = false;
    let history = []; 
    let zoomTimer;
    let initialScale = 1;

    function loadBg(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            guideImg.src = e.target.result;
            guideImg.style.display = "block";
            guideImg.onload = () => {
                canvas.width = guideImg.naturalWidth;
                canvas.height = guideImg.naturalHeight;
                wrapper.style.width = guideImg.naturalWidth + "px";
                wrapper.style.height = guideImg.naturalHeight + "px";
                
                // AUTOMATICK√ù FIT: V√Ωpoƒçet aby sa A4 zmestila na ≈°√≠rku
                initialScale = container.clientWidth / canvas.width;
                wrapper.style.transform = `scale(${initialScale})`;
                saveState();
            };
        };
        reader.readAsDataURL(file);
    }

    function getPos(e) {
        const rect = canvas.getBoundingClientRect();
        // Prepoƒçet s√∫radn√≠c podƒæa aktu√°lnej mierky transform√°cie
        const currentScale = rect.width / canvas.width;
        return {
            x: (e.clientX - rect.left) / currentScale,
            y: (e.clientY - rect.top) / currentScale,
            pressure: e.pressure || 0.5
        };
    }

    // --- LOGIKA DLH√âHO PODR≈ΩANIA (3 SEKUNDY) ---
    canvas.addEventListener('pointerdown', (e) => {
        if (e.pointerType === 'pen') {
            e.preventDefault();
            
            // ≈†tart ƒçasovaƒça pre Lupu (3s)
            statusMsg.style.display = 'block';
            zoomTimer = setTimeout(() => {
                smartZoom(e);
            }, 3000);

            drawing = true;
            const pos = getPos(e);
            ctx.beginPath();
            ctx.moveTo(pos.x, pos.y);
        }
    });

    canvas.addEventListener('pointermove', (e) => {
        if (drawing && e.pointerType === 'pen') {
            // Ak sa pero h√Ωbe, zru≈°√≠me ƒçasovaƒç lupy (nechceme lupu poƒças p√≠sania)
            clearTimeout(zoomTimer);
            statusMsg.style.display = 'none';

            const pos = getPos(e);
            ctx.lineWidth = (pos.pressure * 2.5) + 0.8;
            if(ctx.globalCompositeOperation === 'destination-out') ctx.lineWidth = 30;
            ctx.lineCap = 'round';
            ctx.lineTo(pos.x, pos.y);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(pos.x, pos.y);
        }
    });

    window.addEventListener('pointerup', () => {
        clearTimeout(zoomTimer);
        statusMsg.style.display = 'none';
        drawing = false;
        if(history[history.length-1] !== canvas.toDataURL()) saveState();
    });

    function smartZoom(e) {
        statusMsg.style.display = 'none';
        // Pribl√≠≈æime na 2x p√¥vodnej veƒækosti (alebo fixn√∫ ƒçitateƒæn√∫ hodnotu)
        const targetScale = 1.2; 
        wrapper.style.transform = `scale(${targetScale})`;
        
        // Posunieme scroll tak, aby bod kde je pero bol v strede
        const rect = container.getBoundingClientRect();
        container.scrollLeft = (e.clientX - rect.left) * targetScale;
        container.scrollTop = (e.clientY - rect.top) * targetScale;
    }

    function resetZoom() {
        wrapper.style.transform = `scale(${initialScale})`;
        container.scrollLeft = 0;
        container.scrollTop = 0;
    }

    // --- ZVY≈†N√â FUNKCIE ---
    function saveState() {
        if (history.length > 15) history.shift();
        history.push(canvas.toDataURL());
    }
    function undo() {
        if (history.length <= 1) return;
        history.pop(); // Odstr√°nime aktu√°lny
        let img = new Image();
        img.onload = () => { ctx.clearRect(0,0,canvas.width,canvas.height); ctx.drawImage(img,0,0); };
        img.src = history[history.length - 1];
    }
    function setColor(c, id) {
        ctx.globalCompositeOperation = 'source-over'; ctx.strokeStyle = c;
        updateUI(id);
    }
    function setEraser(id) {
        ctx.globalCompositeOperation = 'destination-out';
        updateUI(id);
    }
    function updateUI(id) {
        document.querySelectorAll('.btn-tool').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }
    function clearAll() { if(confirm("Zmaza≈• v≈°etko?")) { ctx.clearRect(0,0,canvas.width,canvas.height); saveState(); } }
    
    function doPrint() {
        document.getElementById('pBg').src = guideImg.src;
        document.getElementById('pHand').src = canvas.toDataURL();
        setTimeout(() => window.print(), 500);
    }
</script>
</body>
</html>
